#!/usr/bin/env ruby
require 'time'

preprocess do
  items.each do |item|
    if item.identifier =~ /^\/blog\//
      item[:kind] = 'article' 
      item[:created_at] = item.identifier[/\d{4}-\d{2}-\d{2}/] if item[:created_at].nil?
      # item[:created_at] = Time.parse(item[:created_at])
    end
  end
  tag = "console"
  content = "<h2>Posts tagged with '#{tag}'</h2>\n\n"
  content << %{<% articles[0..2].each do |post| %>
  <%= render_post articles[0], :comments => false %>
<% end %>}
  items << Nanoc3::Item.new(content, {}, "/blog/tag/#{tag}/")
end

# COMPILATION

compile '/blog/20*' do
  filter :erb
  filter :redcloth
  layout 'post'
end

compile %r(^/(about-me|contact|projects)) do
  filter :erb
  filter :redcloth
  layout 'default'
end

# compile '/blog/tag/*' do
# end

compile '*' do
  filter :erb
  layout 'default'
end

# ROUTING

route '/blog/20*' do
  item.identifier[0..-2].gsub(/(\d{4})-(\d{2})-(\d{2})-(.*)/, '\1/\2/\3/\4') + '.html'
end

route '*' do
  item.identifier + 'index.html'
end

# LAYOUTING

layout '*', :erb
